name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}  # Allows manual trigger from Actions tab

env:
  GCP_PROJECT_ID: acs-stuttgart-2026-semester
  GCP_REGION: us-central1
  APP_ENGINE_SERVICE: default
  GKE_CLUSTER: gcp-compare-cluster
  GKE_ZONE: us-central1-a
  DOCKER_IMAGE: gcr.io/acs-stuttgart-2026-semester/gcp-compare-app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ===== STAGE 1: Tests =====
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test --if-present
        continue-on-error: true

  # ===== STAGE 2: Build & Push =====
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: success()
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker
      
      - name: Build Docker image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }} \
                       -t ${{ env.DOCKER_IMAGE }}:latest \
                       -f gke/Dockerfile .
      
      - name: Push to Google Container Registry
        run: |
          docker push ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.DOCKER_IMAGE }}:latest

  # ===== STAGE 3: Deploy to App Engine =====
  deploy-app-engine:
    name: Deploy to App Engine
    runs-on: ubuntu-latest
    needs: build
    if: success()
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Deploy to App Engine
        run: |
          gcloud app deploy --version=${{ github.run_id }} --quiet
        working-directory: .
      
      - name: Get App Engine URL
        run: |
          URL=$(gcloud app describe --format='value(defaultHostname)')
          echo "APP_ENGINE_URL=https://$URL" >> $GITHUB_ENV
          echo "Health endpoint: https://$URL/health"
      
      - name: Health Check - App Engine
        run: |
          if [ -z "$APP_ENGINE_URL" ]; then
            echo "âŒ APP_ENGINE_URL not set"
            exit 1
          fi
          echo "Checking health at: $APP_ENGINE_URL/health"
          i=0
          while [ $i -lt 60 ]; do
            i=$((i+1))
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$APP_ENGINE_URL/health" 2>/dev/null || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "âœ“ App Engine healthy ($(($i * 2))s)"
              exit 0
            fi
            echo "Attempt $i/60... Status: $STATUS"
            sleep 2
          done
          echo "âŒ Health check timeout after 120 seconds"
          curl -v "$APP_ENGINE_URL/health" || true
          exit 1
        env:
          APP_ENGINE_URL: ${{ env.APP_ENGINE_URL }}

  # ===== STAGE 4: Deploy to GKE =====
  deploy-gke:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build
    if: success()
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Install GKE auth plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --zone ${{ env.GKE_ZONE }}
      
      - name: Update GKE Deployment
        run: |
          kubectl set image deployment/gcp-compare-app \
            app=${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/gcp-compare-app -n default --timeout=10m || {
            echo "âš  Rollout check timed out, but continuing..."
            kubectl get deployment gcp-compare-app -o wide
          }
      
      - name: Get GKE Service IP
        run: |
          echo "Checking for LoadBalancer IP..."
          kubectl get svc gcp-compare-service || true
          echo "Deployment complete - LoadBalancer IP will be assigned shortly"
      
      - name: Verify GKE Deployment
        run: |
          echo "Checking deployment status..."
          kubectl get deployment gcp-compare-app -o wide
          kubectl get pods -l app=gcp-compare
          echo "Checking service status..."
          kubectl get svc gcp-compare-service -o wide
          echo "âœ“ GKE deployment verified"

  # ===== STAGE 5: Verify Deployment =====
  verify:
    name: Verify Deployments
    runs-on: ubuntu-latest
    needs: [deploy-app-engine, deploy-gke]
    if: always()
    
    steps:
      - name: Check deployment status
        run: |
          echo "ğŸ“Š Deployment Status Report"
          echo "================================"
          echo "App Engine: ${{ needs.deploy-app-engine.result }}"
          echo "GKE: ${{ needs.deploy-gke.result }}"
          
          if [ "${{ needs.deploy-app-engine.result }}" = "success" ] || [ "${{ needs.deploy-gke.result }}" = "success" ]; then
            echo ""
            echo "âœ… At least one deployment succeeded"
            exit 0
          else
            echo ""
            echo "âŒ All deployments failed"
            exit 1
          fi

  # ===== STAGE 6: Notify =====
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [verify]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘           DEPLOYMENT COMPLETE                     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… Status: ${{ needs.verify.result }}
          ğŸ“¦ Image: ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}
          
          ğŸ“Š Monitoring Links:
          - App Engine: https://console.cloud.google.com/appengine/metrics
          - GKE: https://console.cloud.google.com/kubernetes/workloads
          
          ğŸš€ Running load tests...
          "
