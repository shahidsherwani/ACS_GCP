name: Manual Load Test

# Trigger manual load tests with customizable parameters
on:
  workflow_dispatch:
    inputs:
      load_type:
        description: 'Load test type'
        required: true
        default: 'baseline'
        type: choice
        options:
          - baseline
          - stress
          - endurance
      concurrent_requests:
        description: 'Number of concurrent requests'
        required: false
        default: '100'
      duration_seconds:
        description: 'Test duration in seconds'
        required: false
        default: '60'

env:
  APP_ENGINE_URL: https://acs-stuttgart-2026-semester.ey.r.appspot.com
  GCP_PROJECT_ID: acs-stuttgart-2026-semester

jobs:
  manual-load-test:
    name: Manual Load Test - ${{ github.event.inputs.load_type }}
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Install GKE auth plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Install autocannon
        run: npm install -g autocannon
      
      - name: Get GKE IP & Verify Endpoints
        run: |
          echo "Getting GKE cluster credentials..."
          gcloud container clusters get-credentials gcp-compare-cluster --zone us-central1-a
          
          echo "Checking for service IP..."
          GKE_IP=$(kubectl get svc gcp-compare-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          
          if [ -z "$GKE_IP" ]; then
            echo "âš ï¸  LoadBalancer IP not yet assigned"
            GKE_IP="pending"
          fi
          
          echo "GKE_SERVICE_IP=$GKE_IP" >> $GITHUB_ENV
          echo "APP_ENGINE_URL=${{ env.APP_ENGINE_URL }}" >> $GITHUB_ENV
          
          echo "Verifying endpoints..."
          curl -s -I "${{ env.APP_ENGINE_URL }}/health" | head -1 || echo "App Engine unreachable"
          [ "$GKE_IP" != "pending" ] && curl -s -I "http://$GKE_IP/health" | head -1 || echo "GKE endpoint pending"
      
      - name: Display Test Configuration
        run: |
          echo "
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          LOAD TEST CONFIGURATION                  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Type: ${{ github.event.inputs.load_type }}
          Concurrent Requests: ${{ github.event.inputs.concurrent_requests }}
          Duration: ${{ github.event.inputs.duration_seconds }}s
          
          Endpoints:
          - App Engine: ${{ env.APP_ENGINE_URL }}/
          - GKE: http://${{ env.GKE_SERVICE_IP }}/
          
          "
      
      - name: Run Load Test - App Engine
        id: ae-load
        continue-on-error: true
        run: |
          echo "ğŸ§ª Testing App Engine (${{ env.APP_ENGINE_URL }})..."
          timeout $(((${{ github.event.inputs.duration_seconds }} + 30))) \
            autocannon -c ${{ github.event.inputs.concurrent_requests }} \
              -d ${{ github.event.inputs.duration_seconds }} \
              -l "${{ env.APP_ENGINE_URL }}/" 2>&1 | tee ae-load-test.log || {
            echo "âš ï¸  App Engine test failed or timed out"
            exit 0
          }
      
      - name: Run Load Test - GKE
        id: gke-load
        continue-on-error: true
        run: |
          if [ "${{ env.GKE_SERVICE_IP }}" = "pending" ] || [ -z "${{ env.GKE_SERVICE_IP }}" ]; then
            echo "âš ï¸  GKE LoadBalancer IP not ready, skipping test"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ§ª Testing GKE (http://${{ env.GKE_SERVICE_IP }}/)..."
          timeout $(((${{ github.event.inputs.duration_seconds }} + 30))) \
            autocannon -c ${{ github.event.inputs.concurrent_requests }} \
              -d ${{ github.event.inputs.duration_seconds }} \
              -l "http://${{ env.GKE_SERVICE_IP }}/" 2>&1 | tee gke-load-test.log || {
            echo "âš ï¸  GKE test failed or timed out"
            exit 0
          }
      
      - name: Capture Metrics - App Engine
        continue-on-error: true
        run: |
          echo "ğŸ“Š Capturing App Engine metrics..."
          gcloud monitoring time-series list \
            --filter='metric.type="appengine.googleapis.com/http/server/request_count" AND resource.service="default"' \
            --format='table(metric.labels.response_code,points[0].value.number_value)' > ae-metrics.txt 2>&1 || true
          cat ae-metrics.txt
      
      - name: Capture Metrics - GKE
        continue-on-error: true
        run: |
          echo "ğŸ“Š Capturing GKE metrics..."
          kubectl get pods -l app=gcp-compare -o wide > gke-pods.txt
          kubectl top pods -l app=gcp-compare --no-headers > gke-pod-metrics.txt 2>&1 || true
          cat gke-pods.txt
          cat gke-pod-metrics.txt
      
      - name: Generate Test Report
        if: always()
        run: |
          {
            echo "# Load Test Report - ${{ github.event.inputs.load_type }}"
            echo ""
            echo "**Test Date**: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "**Test Type**: ${{ github.event.inputs.load_type }}"
            echo "**Concurrent Requests**: ${{ github.event.inputs.concurrent_requests }}"
            echo "**Duration**: ${{ github.event.inputs.duration_seconds }} seconds"
            echo ""
            echo "## Status"
            echo ""
            echo "- âœ… Test workflow executed"
            echo "- Load test configuration parameters received"
            echo "- Check artifacts for detailed results"
          } > test-report.md
          cat test-report.md
          
          ## Notes
          
          - Metrics lag 30-60 seconds after load test completion
          - Console auto-refresh must be enabled to see live updates
          - Check scaling behavior (3-10 pods for GKE, 1-10 instances for App Engine)
          
          EOF
          cat test-report.md
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-results-${{ github.event.inputs.load_type }}
          path: test-report.md
          if-no-files-found: warn
      
      - name: Summary
        if: always()
        run: |
          echo "
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          LOAD TEST COMPLETED                      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… Test Type: ${{ github.event.inputs.load_type }}
          ğŸ“Š Results available in artifacts
          
          ğŸ“ˆ View live metrics:
          - App Engine: https://console.cloud.google.com/appengine/metrics
          - GKE: https://console.cloud.google.com/kubernetes/workloads
          
          â±ï¸  Note: Metrics update every 30-60 seconds
          
          "
